---
title: "FOI"
author: Leo Lahti
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
---


FOI request
===========

```{r foi-init, message=FALSE, echo=FALSE}
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)
theme_set(theme_bw(20))
# License fee data URL
f <- "~/data/Tietopyynto/20160607\ Kustantajahintatiedot_koottu_v0.99.csv"
# Read the data
df <- read.csv(f, fileEncoding = "latin1")
# Rename
df = rename(df, Publisher = Kustantaja.Välittäjä)
df = rename(df, Organization = Organisaation.nimi)
df = rename(df, Material = Aineistotyyppi)
df = rename(df, Type = Hankintatapa)
df = rename(df, Year = Vuosi)
df = rename(df, Price = Hinta)
```


### Total costs by organization 2010-2015

```{r foi-totalcosts, message=FALSE, echo=FALSE, fig.show="hold", out.width="300px"}
dfs = df %>% group_by(Organisaation.tyyppi) %>% summarise(Costs = sum(Price)) %>% arrange(Costs)
dfs$Organisaation.tyyppi = factor(dfs$Organisaation.tyyppi, levels = as.character(dfs$Organisaation.tyyppi))
p <- ggplot(dfs, aes(x = Organisaation.tyyppi, y = round(Costs/1e6))) + geom_bar(stat = "identity") + ggtitle("Costs by organization type") + coord_flip() + xlab("") + ylab("Total Costs (Million EUR)")
print(p)

dfs = df %>% group_by(Organization) %>% summarise(Costs = round(sum(Price)/1e6)) %>% arrange(desc(Costs))
dfss = dfs[1:20, ]; 
dfs$Organization = factor(dfs$Organization, levels = as.character(dfs$Organization))
p <- ggplot(dfs, aes(x = Organization, y = round(Costs))) + geom_bar(stat = "identity") + ggtitle("Costs by organization") + coord_flip() + xlab("") + ylab("Total Costs (Million EUR)")
print(p)

names(dfs) = c("Organization", "Total (MEUR)")
write.csv(dfs, file = "table/cost_by_organization.csv", quote = F, row.names = F)

dfs = df %>% group_by(Publisher) %>% summarise(Costs = round(sum(Price)/1e6)) %>% arrange(desc(Costs))
dfss = dfs[1:20, ]; 
dfs$Publisher = factor(dfs$Publisher, levels = as.character(dfs$Publisher))
p <- ggplot(dfs, aes(x = Publisher, y = round(Costs))) + geom_bar(stat = "identity") + ggtitle("Costs by organization") + coord_flip() + xlab("") + ylab("Total Costs (Million EUR)")
print(p)

names(dfs) = c("Publisher", "Total (MEUR)")
write.csv(dfs, file = "table/cost_by_publisher.csv", quote = F, row.names = F)


dfs = df %>% group_by(Material) %>% summarise(Costs = round(sum(Price)/1e6)) %>% arrange(desc(Costs))
dfss = dfs[1:20, ]; 
dfs$Material = factor(dfs$Material, levels = as.character(dfs$Material))
p <- ggplot(dfs, aes(x = Material, y = round(Costs))) + geom_bar(stat = "identity") + ggtitle("Costs by organization") + coord_flip() + xlab("") + ylab("Total Costs (Million EUR)")
print(p)

names(dfs) = c("Material", "Total (MEUR)")
write.csv(dfs, file = "table/cost_by_material.csv", quote = F, row.names = F)


dfs = df %>% group_by(Type) %>% summarise(Costs = round(sum(Price)/1e6)) %>% arrange(desc(Costs))
dfss = dfs[1:20, ]; 
dfs$Type = factor(dfs$Type, levels = as.character(dfs$Type))
p <- ggplot(dfs, aes(x = Type, y = round(Costs))) + geom_bar(stat = "identity") + ggtitle("Costs by organization") + coord_flip() + xlab("") + ylab("Total Costs (Million EUR)")
print(p)

names(dfs) = c("Type", "Total (MEUR)")
write.csv(dfs, file = "table/cost_by_type.csv", quote = F, row.names = F)


dfs = df %>% group_by(Year) %>% summarise(Costs = round(sum(Price)/1e6)) %>% arrange(desc(Costs))
dfss = dfs[1:20, ]; 
dfs$Year = factor(dfs$Year, levels = as.character(dfs$Year))
p <- ggplot(dfs, aes(x = Year, y = round(Costs))) + geom_bar(stat = "identity") + ggtitle("Costs by organization") + coord_flip() + xlab("") + ylab("Total Costs (Million EUR)")
print(p)

names(dfs) = c("Year", "Total (MEUR)")
write.csv(dfs, file = "table/cost_by_year.csv", quote = F, row.names = F)
```

 * [Total costs by organization (complete table)](table/cost_by_organization.csv).
 * [Total costs by publisher (complete table)](table/cost_by_publisher.csv).
 * [Total costs by material](table/cost_by_material.csv).
 * [Total costs by type](table/cost_by_type.csv).
 * [Total costs by year](table/cost_by_year.csv).   



```{r foi-plots, message=FALSE, eval=TRUE, echo=FALSE, fig.show="hold", out.width="400px"}
# Price, Year : all publishers
# Growth percentage compared to previous year is shown
dfs <- df %>% group_by(Year) %>% summarise(Price = sum(Price)) %>% arrange(Year)
p <- ggplot(dfs, aes(x = Year, y = Price)) +
       geom_bar(stat = "identity") + ggtitle("Hintojen kehitys") +
       geom_text(data = dfs[-1,], aes(x = Year, y = 1.042 * Price,
     label = paste(round(100 * diff(dfs$Price)/dfs$Price[-length(dfs$Price)], 1), "%", sep = "")   ),
     	   size = 8) + 
       ylab("Price (EUR)")
print(p)
```


## Publication costs with top publishers 2010-2015

```{r foi-toppublishercosts, message=FALSE, eval=TRUE, echo=FALSE, fig.show="hold", out.width="200px"}
# Kokonaishinta : all publishers
dfs <- df %>% group_by(Publisher) %>% summarise(Price = sum(Price)) %>% arrange(desc(Price))
kable(head(dfs, 20))
```


## Cost development by publisher over time

Top-10 publishers shown (out of `r nrow(dfs)`) correspond to `r sum(dfs$Price[1:10])/sum(dfs$Price)`% of the overall costs.

```{r foi-timebypublisher, message=FALSE, eval=TRUE, echo=FALSE, fig.show="hold", out.width="200px"}
top.publishers <- as.character(dfs$Publisher[1:10])
# Price, Year : individual publishers compared
# Growth percentage compared to previous year is shown
dfs <- dplyr::filter(df, Publisher %in% top.publishers) %>% group_by(Year, Publisher) %>% summarise(Price = sum(Price)) %>% arrange(Year)
dfs$Publisher <- factor(dfs$Publisher, levels = top.publishers)
p <- ggplot(dfs, aes(x = Year, y = Price, color = Publisher)) +
       geom_point() +
       geom_line() +       
       ggtitle("Kokonaishintojen kehitys kustantajittain") +
       ylab("Price (EUR)") 
print(p)
```


### Relative increase in costs 2015 vs 2010

```{r foi-time, message=FALSE, eval=TRUE}
dfs <- df %>% group_by(Year, Publisher) %>% summarise(Price = sum(Price)) %>% arrange(Year)
dfss <- spread(dfs, Year, Price)
kasvu <- unlist(dfss[, "2015"]/dfss[, "2010"]);
names(kasvu) <- as.character(dfss$Publisher)
sort(kasvu)

# Relative prices with 2010 baseline
# Top relative increase
kustantajat <- dfss[,1]
hinnat = as.matrix(dfss[, -1])
hinnat <- hinnat/hinnat[,1]
dfs2 <- as.data.frame(hinnat)
dfs2$Publisher <- as.character(unlist(kustantajat, use.names = F))
dfs2 <- dfs2[!is.na(dfs2[, "2015"]),]
dfs2 <- dfs2[rev(order(dfs2[, "2015"])),]
top <- as.character(unlist(dfs2$Publisher, use.names = F)[1:10])
dfs3 <- dfs[unlist(dfs$Publisher) %in% top,]
dfs3$Publisher <- as.character(unlist(dfs3$Publisher, use.names = F))
dfs3$Publisher <- factor(dfs3$Publisher, levels = top)
dfs3$Year <- as.numeric(as.character(dfs3$Year))
dfs3$Price <- as.numeric(as.character(dfs3$Price))
p <- ggplot(dfs3,
       aes(x = Year, y = Price, color = Publisher)) +
       geom_point() +
       geom_line() +       
       ggtitle("Kokonaishintojen suhteellinen kehitys kustantajittain") +
       ylab("Price (EUR)") 
print(p)
```


